---
title: "01_exp_data"
author: "Puvvula"
date: "2023-07-17"
output: pdf_document
---

```{r}
library(pacman)
pacman::p_load(tidyverse, janitor, haven)

dat_loc <- "~/Documents/ope_ssis/data/"
res<- "~/Documents/ope_ssis/result/"
```

#ope data - pre and post natal exposure data received from aimin on Dec 13, 2023
```{r}
ope_exp_n1<- read_sas(paste0(dat_loc, "raw/dec_23_new_ver/ur_fr_sg_20210921.sas7bdat")) |>
  clean_names() 
  #|>filter(flg_nr == 0)

#ope data - p4 visit

ope_exp_n2<- read_sas(paste0(dat_loc, "raw/dec_23_new_ver/ur_fr_12y.sas7bdat")) |>
  clean_names() 
  # |> filter(flg_nr == 0)
```

#append longitudinal exposure data
```{r}
ope_exp <- bind_rows(ope_exp_n1, ope_exp_n2) |>
  mutate(visit = case_when(
    visit == "16W" ~ "prenatal_16W",
    visit == "26W" ~ "prenatal_26W",
    visit == "Birth" ~ "delivery",
    visit == "12M" ~ "postnatal_1_yr",
    visit == "24M" ~ "postnatal_2_yr",
    visit == "36M" ~ "postnatal_3_yr",
    visit == "60M" ~ "postnatal_4_yr",
    visit == "P3" ~ "postnatal_5_yr",
    visit == "P4" ~ "postnatal_8_yr",
    TRUE ~ as.character(visit)
  ))
```

#lod summaries
```{r}
bel_lod_summaries <- ope_exp |>
  group_by(analyte_code, visit) |>
  summarize(freq_bel_lod = sum(flg_lod == 1, na.rm = TRUE),
            total_obs = n(),
            pct_bel_lod = round((freq_bel_lod / total_obs) * 100, 2))

write_csv(bel_lod_summaries, paste0(res, "bel_lod_summaries.csv"))
```

#remove exposures if fraction <LOD is >=60% 
```{r}
ope_exp_filtered<- ope_exp  |>
  mutate(analyte_code = tolower(analyte_code)) |>
  mutate(analyte_code = fct_recode(as.factor(analyte_code), 
                             bcep = "bcetp", bdcipp = "bdcpp", 
                             dnbp = "dbup", dphp = "dphp"))|>
  group_by(visit, analyte_code) |>
  mutate(median_sg = median(specific_gravity, na.rm = TRUE)) |>
  mutate(result_sg_adj= result * (median_sg - 1) / (specific_gravity - 1), na.rm=T)

#exposure summary pre-imputation
exp_summary <- ope_exp_filtered |>
  group_by(analyte_code, visit) |>
  summarize(freq_bel_lod = sum(flg_lod == 1, na.rm = TRUE),
            total_obs = n(),
            pct_bel_lod = round((freq_bel_lod / total_obs) * 100, 2),
            median_iqr = paste(
              round(quantile(result_sg_adj, 0.5, na.rm = TRUE), 2), "(", 
              round(quantile(result_sg_adj, 0.25, na.rm = TRUE), 2), "-", 
              round(quantile(result_sg_adj, 0.75, na.rm = TRUE), 2), ")"
              ),
            analyte_lod = first(analyte_lod))


write_csv(exp_summary, paste0(res, "exp_summary_pre_imp.csv"))
```

#data prep for analytic set
```{r}
exp_dat <- ope_exp_filtered |>
  filter(!analyte_code %in% c("dbzp", "dcp", "tbba", "bcpp", "ipppp", "tbppp")) |>
  select(c(1, 2, 4, 5)) |>
  group_by(participant_id, analyte_code, visit) |>
  summarise(result = mean(result, na.rm = TRUE), .groups = "drop") |>
  mutate(result = replace_na(result, NA)) |>
  pivot_wider(names_from = c(analyte_code, visit), values_from = result) |>
  as_tibble()
```

#export exposure data
```{r}
write_csv(exp_dat, paste0(dat_loc, "exp_dat.csv"))
```



